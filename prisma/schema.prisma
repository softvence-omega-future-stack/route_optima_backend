// Database definition for PostgreSQL
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Prisma Client generator
generator client {
  provider = "prisma-client-js"
}

// ------------------------------------
// ENUMS
// ------------------------------------

enum UserRole {
  ADMIN
  TECHNICIAN
  DISPATCHER
}

enum JobStatus {
  ASSIGNED
  COMPLETED
}

enum JobType {
  CHIMNEY_SWEEP
  LOCKSMITH
  DRYER_VENT_CLEANING
}

model User {
  id                 String                @id @default(uuid())
  email              String                @unique
  password           String
  name               String?
  photo              String?
  role               UserRole              @default(DISPATCHER)
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt

  technicianId       String?               @unique
  technician         Technician?          @relation(fields: [technicianId], references: [id])

  dispatcherId       String?               @unique
  dispatcher         Dispatcher?          @relation(fields: [dispatcherId], references: [id])

  sessions           Session[]
  PasswordResetToken PasswordResetToken[]
  createdJobs        Job[]                @relation("JobCreator")
}

// Model for managing long-term user sessions and tokens.
model Session {
  id           String    @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id])

  refreshToken String?
  expiresAt    DateTime
  isActive     Boolean   @default(true)

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  token     String    @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  expiresAt DateTime
  used      Boolean   @default(false)
  createdAt DateTime  @default(now())
}

// Model for managing field technicians
model Technician {
  id            String    @id @default(uuid())
  name          String
  phone         String    @unique
  address       String?
  photo         String?
  workStartTime String?
  workEndTime   String?
  isActive      Boolean   @default(true)

  user          User?

  jobs          Job[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// Model for managing dispatchers
model Dispatcher {
  id            String    @id @default(uuid())
  name          String
  phone         String?   @unique
  address       String?
  photo         String?
  isActive      Boolean   @default(true)

  user          User?

  jobs          Job[]     @relation("DispatcherJobs")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model DefaultTimeSlot {
  id                                                   String    @id @default(uuid())
  label                                                String
  startTime String // Format: "08:00" (24-hour format)
  endTime   String // Format: "10:00" (24-hour format)
  order                                                Int       @default(autoincrement())
  isActive                                             Boolean   @default(true)
  jobs                                                 Job[]

  createdAt                                            DateTime  @default(now())
  updatedAt                                            DateTime  @updatedAt

  @@index([isActive,                                   order])
}

// Model for a scheduled job or appointment
model Job {
  id                                            String           @id @default(uuid())
  // Customer Information
  customerName                                  String
  customerPhone                                 String
  customerEmail                                 String?
  serviceAddress                                String
  zipCode                                       String?
  street                                        String?
  city                                          String?
  state                                         String?
  stateCode                                     String?
  latitude                                      Float?
  longitude                                     Float?

  // Job Details
  companyName                                   String?
  jobSource                                     String?
  jobType                                       JobType?
  jobDescription                                String

  // Schedule Information (already in Job - perfect!)
  scheduledDate DateTime // Date from form
  timeSlotId    String // Selected time slot ID
  timeSlot                                      DefaultTimeSlot @relation(fields: [timeSlotId], references: [id])
  technicianId                                  String
  technician                                    Technician      @relation(fields: [technicianId], references: [id], onDelete: Cascade)

  // Dispatcher tracking
  dispatcherId                                  String?
  dispatcher                                    Dispatcher?     @relation("DispatcherJobs", fields: [dispatcherId], references: [id])

  // Creator tracking - who created this job (admin or dispatcher)
  createdBy                                     String?
  creator                                       User?           @relation("JobCreator", fields: [createdBy], references: [id])

  status                                        JobStatus        @default(ASSIGNED)
  
  // Financial Information
  totalAmount                                   Float?
  partsCost                                     Float?
  techProfit                                    Float?

  createdAt                                     DateTime         @default(now())
  updatedAt                                     DateTime         @updatedAt
}

model NotificationPreferences {
  id                String    @id @default("singleton")
  sendCustomerEmail Boolean   @default(true)
  sendTechnicianSMS Boolean   @default(true)

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}
